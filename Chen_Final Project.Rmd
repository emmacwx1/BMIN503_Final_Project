---
title: "Chen_Final Project"
author: "Emma Chen"
date: "11/21/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(root.dir = 'C:/Users/Emma/Documents/BMIN503_Final_Project')
getwd()
```

Overview: 
My project study whether administration of both JAK inhibitors and immune checkpoint blockade therapy (anti-PD1) improves tumor resistance so patients will response to immunotheray better, improve survival and have powerful tumor response. My dataet included immune profile measured by Flow Cytometry and CyTOF of 6 patients’ PBMC blood sample across 6 timepoints as well as clinical data, further allowing me to investigate clinical profile relationship with immune profile on patients.

Introduction: 
My project is to investigate whether combined administration of JAK inhibitor and immune checkpoint blockade (ICB)–anti-PD1 immunotherapy is better than with only ICB over time. Currently, ICB, either anti-PD1 or anti-CTLA4, is used to treat cancer patients. ICB functions as taking the brake off immune system’s response to cancer. However, many patients treated with ICB relapsed or their cancer progresses, leading to the idea that taking one break off is not enough, multiple brakes needs to be released. Dr. Minn at Penn Medicine found out that interferon (IFN) pathway is critical to tumor’s resistance to immunotherapy, which also means shutting down the IFN pathway may improve the response to ICB. He found out that Janus kinase (JAK) inhibitor could overcome the resistance to immunotherapy, improving survival and powerful tumor responses.

Since this finding, some patients were given only ICB or both ICB and JAK inhibitors to test if JAK inhibitors actually improve tumor resistance problem. Clinical data and blood samples were obtain from 6 patients in our study across 6 different timepoints (every week for 6 weeks). Blood samples were processed to PBMC, stained with extracellular and intracellular protein markers, ran in both Flow Cytometry and CyTOF (using metal ions instead of fluorochromes) to assess immune profile. There are multiple parameters/variables in the diverse datasets that worth investigating. First of all, patient treatment has 2 types: ICB only versus both JAK inhibitors and ICB combination, allowing us to confirm main hypothesis whether IFN pathway inhibition improve ICB immunotherapy effects. Second of all, immune profile is measured in both Flow Cytometry and CyTOF, one method might have different or new insights that the other does not provide. Thirdly, having longitudinal samples from multiple patients is precious and rare so we can investigate immune response in short-term and in long-term, whether patient might have relapsed cancer. Last but not least, clinical data can be used to profile patients and determine if clinical data has correlation to patient’s immune profile.

Methods and Results: 

To analyze protein expression from Flow Cytometry, we first use MEM (Marker Enrichment Modeling) package developed by the Irish Lab of Vandebilt University.  
```{r}
# Load all libraries
library(FlowSOM)
library(flowCore)
library(Biobase)
library(gplots)
library(ggplot2)
library(hexbin)
library(MEM)
library(tidyverse)
library(Rtsne)
library(uwot)
library(viridis)
library(ggExtra)
```


Read flow data (.fcs files), assign MEM based on MEM function, generate heatmap on protein expression 

Step1: set working directory
```{r}
# read FCS files into R
setwd("C:/Users/Emma/Documents/BMIN503_Final_Project")
getwd()
```

Step2: look at concatenated fcs file first to find out markers names. For this project, 1 file is 1 cluster with multiple patients' sample across multiple timepoints. 
```{r}
#replace with fcs file name of dataset
##Read in concatenated FCS file ---- 
concat <-  dir(pattern="*concat2_1.fcs")


test.data = read.FCS(concat, transformation="linearize", which.lines=NULL,
         alter.names=FALSE, column.pattern=NULL, invert.pattern = FALSE,
         decades=0, ncdf = FALSE, min.limit=NULL, 
         truncate_max_range = TRUE, dataset=NULL, emptyValue=TRUE, 
         channel_alias = NULL)

colnames(test.data)
markernames(test.data)

#columns need to be renamed: 7:31
#columns need to be used for SOM
#There are 25 markers for later analysis: "CD45RA, CXCR5, PD1, IgG4, dump, CD8, CD127, Tox, Tim3, Eomes, TCF1, CD38, CCR7, CTLA-4, CD226, CD39, FoxP3, Ki67, CD27, CD4, CD73,TIGIT, T-bet, CD28, CD3"

```

```{r}
##Read in concatenated FCS file ---- 
concat <-  dir(pattern="*.fcs")


#read column names and row names
#exclude FSC, SSC, 

## Run FlowSOM ----
# Set file path to concatenated file or type fileName
# run compensation if you are using uncompensated fcs files (not applicable for CyTOF)
# toTransform, indicate the channels you need to apply transformation to
# colToUse, indicate the channels you would like to use to create your SOM
fSOM <- FlowSOM(concat,
                # Input options:
               #a flowFrame, a flowSet or an arra of paths to files
                compensate = FALSE, 
                transform = TRUE, 
                toTransform=c(7:31), #colnames or indices that needs to be transformed/rename
                scale = FALSE,
                # SOM options:
                colsToUse = c(12, 26), #column nams or indices to use for building the SOM, include cell type markers, exclude behavioral-related markers
                xdim = 10, 
                ydim = 10,   
                # Metaclustering options and set seed for reproducibility:
                nClus = 20, 
                seed = 42)

PlotStars(fSOM[[1]])
PlotStars(fSOM$FlowSOM,backgroundValues = as.factor(fSOM$metaclustering))

## Output a csv file with the flowSOM cluster information ----
# You will need to "un-concatenate" this file in Cytobank, FlowJo, or R
flowSOM.clustering <- as.matrix(fSOM[[2]][fSOM[[1]]$map$mapping[,1]])
write.csv(flowSOM.clustering, "C:/Users/Allie/Desktop/FCS files/2017/2017-10-13 FCS files for monocyte comparison/FCS files w tSNE for FlowSOM/RCC/RCC_concat.csv")


```


```{r}
#get all .fcs file in dataset
analysis <-  dir(pattern = "*.fcs")

MEM.values.orig = MEM(
  analysis,
  transform = TRUE, 
  #whether or not to apply asinh transformation to the data. default is FALSE
  cofactor = 15,
  #if transform is TRUE, what cofactor should be applied. default is 1. Arcsinh transformed value = arcsinh(raw value/cofactor)
  choose.markers = TRUE, 
  #TRUE=data contains markers that will NOT be used in the analysis (e.g. SSC or FSC channels in flow data)
  #FALSE, either all markers in exp will be used in MEM or the user can pass a character string of the markers to be used in the analysis using the function call (markers) below
  markers = "7:31",    
  #all or column index 
  choose.ref = FALSE,   
  #default reference for each population is all other popultaions.any clusters you want to use as reference?? possible landmark pop if wanted 
  zero.ref = FALSE,   
  #TRUE=a zero, or synthetic negative, referece will be used for all populations. MAGref therefore is 0 and IQRref is the median IQR across all markers chosen. 
  rename.markers = TRUE,   
  #if false, either column names will not be changed or the user can pass a character string of the new column names using the function call (new.marker.names) below
  new.marker.names = "CD45RA, CXCR5, PD1, IgG4, dump, CD8, CD127, Tox, Tim3, Eomes, TCF1, CD38, CCR7, CTLA-4, CD226, CD39, FoxP3, Ki67, CD27, CD4, CD73,TIGIT, T-bet, CD28, CD3",
  file.is.clust = TRUE,   
  #TRUE=multiple files are entered, each file contains cells from only 1 cluster. 
  #Divij sample is 1 cluster 1 file
  #will merge data into one matrix for analysis and to add a file ID for each file that will stand in as the cluster ID (??cluster=file?) output=a text file indicating which file corresponds to which cluster number will be written to the output files folder 
  add.fileID = FALSE,  
  #multi files, but not 1 file = 1 cluster; instead, 1 file contains multiple cluster, and that there is already a cluster channel included as the last column in each file. 
  ##QUESTION: what if 1 file does has multiple clusters, but there is no cluster channel included as the last column in each file? 
  #if TRUE, a file ID will be appended to the cluster ID so user can ID the file as well as cluster from which each population came.  
  IQR.thresh = NULL
)

# build MEM heatmap and output enrichment scores
build.heatmaps(
  MEM.values.orig,
  cluster.MEM = "both",
  display.thresh = 1,
  newWindow.heatmaps = FALSE,
  output.files = FALSE,
  labels = TRUE,
  only.MEMheatmap = FALSE
)

# prepare data for use in UMAP
data <- lapply(lapply(analysis, read.FCS), exprs)
ID <- c(1:length(data))
combined.data = as.data.frame(do.call(rbind, mapply(
  cbind, data, "File ID" = ID, SIMPLIFY = F
)))
combined.data$`File ID` <- as.numeric(combined.data$`File ID`)
chosen.markers = combined.data[, c(7:31)]
transformed.chosen.markers <- chosen.markers %>%
  mutate_all(function(x)
    asinh(x / 15))
overall_seed = 43
#FlowSOM algorithm is a randonly determined process.

#set the seed of pseudorandom number generator in the computer to repeat the same FlowSOM run on the SAME DATA with the SAME setting and get the exact SAME RESULTS. 

#to validate reproducibility where required.

#choose the seed? Cytobank will set one for you if you run FlowSOM on Cytobank. you can see the seed that was selected by viewing the settings that were used for the FlowSOM run. 

#CytoBank link (search "seed"): https://support.cytobank.org/hc/en-us/articles/360015918512-How-to-Configure-and-Run-a-FlowSOM-Analysis
```


```{r UMAP}
# Run UMAP on all surface markers
set.seed(overall_seed)
myumap <-
  umap(transformed.chosen.markers,
       ret_model = TRUE,
       n_threads = 1, 
       verbose = TRUE)
umap.data = as.data.frame(myumap$embedding)

range <- apply(apply(umap.data, 2, range), 2, diff)
graphical.ratio <- (range[1] / range[2])

# UMAP flat dot plot and density dot plot
UMAP.plot <- data.frame(x = umap.data[, 1], y = umap.data[, 2])

ggplot(UMAP.plot) + coord_fixed(ratio = graphical.ratio) + 
  geom_point(aes(x = x, y = y), cex = 1) + labs(x = "UMAP 1", y = "UMAP 2", 
                                                title = "UMAP on PBMC Data") + 
  theme_bw() + 
  labs(caption = "Data from Digggins et al., Nat Methods 2017, 14: 275-278 \nFlow Repository: FR-FCM-ZY63")

ggplot(UMAP.plot, aes(x = x, y = y)) + coord_fixed(ratio = graphical.ratio)  + 
  geom_bin2d(bins = 128) +
  scale_fill_viridis_c(option = "A", trans = "sqrt") + 
  scale_x_continuous(expand = c(0.1, 0)) +
  scale_y_continuous(expand = c(0.1, 0)) + labs(x = "UMAP 1", y = "UMAP 2", 
                                                title = "UMAP on PBMC Data") + 
  theme_bw() + 
  labs(caption = "Data from Diggins et al., Nat Methods 2017, 14: 275-278 \nFlow Repository: FR-FCM-ZY63")
```


```{r FlowSOM on UMAP}
# Run FlowSOM on the UMAP axes
umap.matrix <- as.matrix(umap.data)

# create flowFrame
UMAP.metadata <-
  data.frame(name = dimnames(umap.matrix)[[2]],
             desc = paste('UMAP', dimnames(umap.matrix)[[2]]))
UMAP.metadata$range <- apply(apply(umap.matrix, 2, range), 2, diff)
UMAP.metadata$minRange <- apply(umap.matrix, 2, min)
UMAP.metadata$maxRange <- apply(umap.matrix, 2, max)
umap.flowframe <- new("flowFrame",
                      exprs = umap.matrix,
                      parameters = AnnotatedDataFrame(UMAP.metadata))

# implement the FlowSOM on the data
fsom <-
  FlowSOM(
    umap.flowframe,
    compensate = FALSE,
    transform = FALSE,
    toTransform = c(1:2),
    scale = TRUE,
    colsToUse = c(1:2),
    nClus = 20, #change this
    seed = overall_seed
  )
FlowSOM.clusters <-
  as.matrix(fsom[[2]][fsom[[1]]$map$mapping[, 1]])

# plot FlowSOM clusters on UMAP axes
ggplot(UMAP.plot) + coord_fixed(ratio=graphical.ratio) + 
  geom_point(aes(x=x, y=y, color=FlowSOM.clusters),cex = 1.5) + 
  labs(x = "UMAP 1", y = "UMAP 2",title = "FlowSOM Clustering on UMAP Axes", 
       color = "FlowSOM Cluster") + theme_bw() + 
  guides(colour = guide_legend(override.aes = list(size=5)))+
  labs(caption = "Data from Diggins et al., Nat Methods 2017, 14: 275-278 \nFlow Repository: FR-FCM-ZY63")
```

```{r MEM on UMAP/FlowSOM Clusters}
# Run MEM on the FlowSOM clusters from UMAP
cluster = as.numeric(as.vector((FlowSOM.clusters)))
MEM.data = cbind(transformed.chosen.markers, cluster)

MEM.values.uf = MEM(
  MEM.data,
  transform = FALSE,
  cofactor = 15,
  choose.markers = FALSE,
  markers = "all",
  choose.ref = FALSE,
  zero.ref = FALSE,
  rename.markers = FALSE,
  new.marker.names = "CD45RA,CXCR5,PD1,IgG4,dump,CD8,CD127,Tox,Tim3,Eomes,TCF1,CD38,CCR7,CTLA4,CD69,CD103,FoxP3,Ki67,CD27,CD4,CX3CR1,CD39,T-bet,CD28,CD6",
  file.is.clust = FALSE,
  add.fileID = FALSE,
  IQR.thresh = NULL
)

# build MEM heatmap and output enrichment scores
build.heatmaps(
  MEM.values.uf,
  cluster.MEM = "both",
  cluster.medians = "none",
  display.thresh = 1,
  newWindow.heatmaps = FALSE,
  output.files = FALSE,
  labels = TRUE,
  only.MEMheatmap = FALSE
)
```


```{r RMSD for All Clusters}
# RMSD to compare labels from all populations
orig.MEM.scores = as.data.frame(MEM.values.orig[[5]])
rownames(orig.MEM.scores) = paste0(rownames(orig.MEM.scores), " (Fig.1)")
uf.MEM.scores = as.data.frame(MEM.values.uf[[5]])
rownames(uf.MEM.scores) = paste0(rownames(uf.MEM.scores), ' (UMAP)')
all.MEM.values = as.matrix(rbind(uf.MEM.scores, orig.MEM.scores))

RMSD_vals <-
  MEM_RMSD(
    all.MEM.values,
    format = NULL,
    newWindow.heatmaps = FALSE,
    output.matrix = FALSE
  )
```


```{r}
#github update
#git add -A
#git commit -m "[message about commit]"
#git push
#git status
```

